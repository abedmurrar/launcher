---
description: better-sqlite3 usage; reference API at https://github.com/WiseLibs/better-sqlite3/blob/HEAD/docs/api.md
globs: lib/db/**/*.ts
alwaysApply: false
---

# better-sqlite3 (SQLite in Node)

**API:** [better-sqlite3 API](https://github.com/WiseLibs/better-sqlite3/blob/HEAD/docs/api.md)

- **Connection:** Single shared DB via `getDb()` from `lib/db/connection.ts`. Use one connection per process; do not create `new Database()` in route handlers.
- **Statements:** Use **prepared statements**: `db.prepare(sql)` then `.run(...)`, `.get(...)`, or `.all(...)` with [binding parameters](https://github.com/WiseLibs/better-sqlite3/blob/HEAD/docs/api.md#binding-parameters) (`?` positional or `@name`/`:name`/`$name` named). Prefer `.prepare()` + bind over `.exec()` for safety and performance.
- **Single row:** `.get(...)` returns the first row as an object or `undefined`. For **one column only**, use `.pluck(true)` then `.get(...)` to get the scalar value (e.g. `number | undefined`) instead of `{ col: number }`.
- **Many rows:** `.all(...)` returns an array of row objects; use `.pluck(true).all(...)` to get an array of first-column values.
- **Writes:** `.run(...)` returns `{ changes, lastInsertRowid }`. Use `result.lastInsertRowid` for INSERT; use `result.changes` for UPDATE/DELETE when you need the count.
- **Transactions:** For multiple statements that must succeed or fail together, use `db.transaction(() => { ... })`. The callback runs in a transaction; on return it commits, on throw it rolls back. **Do not use async functions** inside `.transaction()` â€” the callback must be synchronous (SQLite serializes transactions; keeping a transaction open across awaits is unsupported).
- **Pragma:** Use `db.pragma('name')` or `db.pragma('name = value')`. For single-value pragmas use `db.pragma('cache_size', { simple: true })` to get the first column of the first row.
- **Errors:** SQLite errors throw `SqliteError` (subclass of `Error`) with a `.code` property (e.g. `SQLITE_CONSTRAINT_UNIQUE`). See [SQLite result codes](https://sqlite.org/rescode.html).
